<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lasso.roadway &mdash; lasso  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../" class="icon icon-home"> lasso
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../starting/">Starting Out</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../setup/">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../running/">Running Lasso</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/">Lasso Classes and Functions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">lasso</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../">Module code</a></li>
      <li class="breadcrumb-item active">lasso.roadway</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lasso.roadway</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">geopandas</span> <span class="kn">import</span> <span class="n">GeoDataFrame</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">network_wrangler</span> <span class="kn">import</span> <span class="n">RoadwayNetwork</span>
<span class="kn">from</span> <span class="nn">.parameters</span> <span class="kn">import</span> <span class="n">Parameters</span>
<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">WranglerLogger</span>


<div class="viewcode-block" id="ModelRoadwayNetwork"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork">[docs]</a><span class="k">class</span> <span class="nc">ModelRoadwayNetwork</span><span class="p">(</span><span class="n">RoadwayNetwork</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subclass of network_wrangler class :ref:`RoadwayNetwork &lt;network_wrangler:RoadwayNetwork&gt;`</span>

<span class="sd">    A representation of the physical roadway network and its properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CALCULATED_VALUES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;area_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;county&quot;</span><span class="p">,</span>
        <span class="s2">&quot;centroidconnect&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="ModelRoadwayNetwork.__init__"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nodes</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">links</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">shapes</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>

<span class="sd">        Args:</span>
<span class="sd">            nodes: geodataframe of nodes</span>
<span class="sd">            links: dataframe of links</span>
<span class="sd">            shapes: geodataframe of shapes</span>
<span class="sd">            parameters: dictionary of parameter settings (see Parameters class) or an instance of Parameters.</span>
<span class="sd">                If not specified, will use default parameters.</span>
<span class="sd">            crs (int): coordinate reference system, ESPG number</span>
<span class="sd">            node_foreign_key (str):  variable linking the node table to the link table</span>
<span class="sd">            link_foreign_key (list): list of variable linking the link table to the node foreign key</span>
<span class="sd">            shape_foreign_key (str): variable linking the links table and shape table</span>
<span class="sd">            unique_link_ids (list): list of variables unique to each link</span>
<span class="sd">            unique_node_ids (list): list of variables unique to each node</span>
<span class="sd">            modes_to_network_link_variables (dict): Mapping of modes to link variables in the network</span>
<span class="sd">            modes_to_network_nodes_variables (dict): Mapping of modes to node variables in the network</span>
<span class="sd">            managed_lanes_node_id_scalar (int): Scalar values added to primary keys for nodes for</span>
<span class="sd">                corresponding managed lanes.</span>
<span class="sd">            managed_lanes_link_id_scalar (int): Scalar values added to primary keys for links for</span>
<span class="sd">                corresponding managed lanes.</span>
<span class="sd">            managed_lanes_required_attributes (list): attributes that must be specified in managed</span>
<span class="sd">                lane projects.</span>
<span class="sd">            keep_same_attributes_ml_and_gp (list): attributes to copy to managed lanes from parallel</span>
<span class="sd">                general purpose lanes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># will have to change if want to alter them</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Parameters should be a dict or instance of Parameters: found </span><span class="si">{}</span><span class="s2"> which is of type:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_metcouncil_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fill_na</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_int</span><span class="p">()</span></div>
        <span class="c1"># self.shapes_metcouncil_df = None</span>
        <span class="c1">##todo also write to file</span>
        <span class="c1"># WranglerLogger.debug(&quot;Used PARAMS\n&quot;, &#39;\n&#39;.join([&#39;{}: {}&#39;.format(k,v) for k,v in self.parameters.__dict__.items()]))</span>

<div class="viewcode-block" id="ModelRoadwayNetwork.read"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.read">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span>
        <span class="n">link_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">node_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">shape_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">recalculate_calculated_variables</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">recalculate_distance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in links and nodes network standard.</span>

<span class="sd">        Args:</span>
<span class="sd">            link_filename (str): File path to link json.</span>
<span class="sd">            node_filename (str): File path to node geojson.</span>
<span class="sd">            shape_filename (str): File path to link true shape geojson</span>
<span class="sd">            fast (bool): boolean that will skip validation to speed up read time.</span>
<span class="sd">            recalculate_calculated_variables (bool): calculates fields from spatial joins, etc.</span>
<span class="sd">            recalculate_distance (bool):  re-calculates distance.</span>
<span class="sd">            parameters: dictionary of parameter settings (see Parameters class) or an instance of Parameters. If not specified, will use default parameters.</span>
<span class="sd">            crs (int): coordinate reference system, ESPG number</span>
<span class="sd">            node_foreign_key (str):  variable linking the node table to the link table</span>
<span class="sd">            link_foreign_key (list): list of variable linking the link table to the node foreign key</span>
<span class="sd">            shape_foreign_key (str): variable linking the links table and shape table</span>
<span class="sd">            unique_link_ids (list): list of variables unique to each link</span>
<span class="sd">            unique_node_ids (list): list of variables unique to each node</span>
<span class="sd">            modes_to_network_link_variables (dict): Mapping of modes to link variables in the network</span>
<span class="sd">            modes_to_network_nodes_variables (dict): Mapping of modes to node variables in the network</span>
<span class="sd">            managed_lanes_node_id_scalar (int): Scalar values added to primary keys for nodes for</span>
<span class="sd">                corresponding managed lanes.</span>
<span class="sd">            managed_lanes_link_id_scalar (int): Scalar values added to primary keys for links for</span>
<span class="sd">                corresponding managed lanes.</span>
<span class="sd">            managed_lanes_required_attributes (list): attributes that must be specified in managed</span>
<span class="sd">                lane projects.</span>
<span class="sd">            keep_same_attributes_ml_and_gp (list): attributes to copy to managed lanes from parallel</span>
<span class="sd">                general purpose lanes.</span>
<span class="sd">        Returns:</span>
<span class="sd">            ModelRoadwayNetwork</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nodes_df</span><span class="p">,</span> <span class="n">links_df</span><span class="p">,</span> <span class="n">shapes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">load_transform_network</span><span class="p">(</span>
            <span class="n">node_filename</span><span class="p">,</span>
            <span class="n">link_filename</span><span class="p">,</span>
            <span class="n">shape_filename</span><span class="p">,</span>
            <span class="n">validate_schema</span><span class="o">=</span><span class="ow">not</span> <span class="n">fast</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">m_road_net</span> <span class="o">=</span> <span class="n">ModelRoadwayNetwork</span><span class="p">(</span>
            <span class="n">nodes_df</span><span class="p">,</span>
            <span class="n">links_df</span><span class="p">,</span>
            <span class="n">shapes_df</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">recalculate_calculated_variables</span><span class="p">:</span>
            <span class="n">m_road_net</span><span class="o">.</span><span class="n">create_calculated_variables</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">recalculate_distance</span><span class="p">:</span>
            <span class="n">m_road_net</span><span class="o">.</span><span class="n">calculate_distance</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">m_road_net</span><span class="o">.</span><span class="n">fill_na</span><span class="p">()</span>
        <span class="c1"># this method is making period values as string &quot;NaN&quot;, need to revise.</span>
        <span class="n">m_road_net</span><span class="o">.</span><span class="n">split_properties_by_time_period_and_category</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m_road_net</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">m_road_net</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_road_net</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NaN&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">m_road_net</span><span class="o">.</span><span class="n">convert_int</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">m_road_net</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.from_RoadwayNetwork"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.from_RoadwayNetwork">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_RoadwayNetwork</span><span class="p">(</span>
        <span class="n">roadway_network_object</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        RoadwayNetwork to ModelRoadwayNetwork</span>

<span class="sd">        Args:</span>
<span class="sd">            roadway_network_object (RoadwayNetwork).</span>
<span class="sd">            parameters: dictionary of parameter settings (see Parameters class) or an instance of Parameters. If not specified, will use default parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ModelRoadwayNetwork</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">additional_params_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">roadway_network_object</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nodes_df&quot;</span><span class="p">,</span> <span class="s2">&quot;links_df&quot;</span><span class="p">,</span> <span class="s2">&quot;shapes_df&quot;</span><span class="p">,</span> <span class="s2">&quot;parameters&quot;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">ModelRoadwayNetwork</span><span class="p">(</span>
            <span class="n">roadway_network_object</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">,</span>
            <span class="n">roadway_network_object</span><span class="o">.</span><span class="n">links_df</span><span class="p">,</span>
            <span class="n">roadway_network_object</span><span class="o">.</span><span class="n">shapes_df</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="o">**</span><span class="n">additional_params_dict</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.split_properties_by_time_period_and_category"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.split_properties_by_time_period_and_category">[docs]</a>    <span class="k">def</span> <span class="nf">split_properties_by_time_period_and_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties_to_split</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits properties by time period, assuming a variable structure of</span>

<span class="sd">        Args:</span>
<span class="sd">            properties_to_split: dict</span>
<span class="sd">                dictionary of output variable prefix mapped to the source variable and what to stratify it by</span>
<span class="sd">                e.g.</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;lanes&#39; : {&#39;v&#39;:&#39;lanes&#39;, &#39;times_periods&#39;:{&quot;AM&quot;: (&quot;6:00&quot;, &quot;10:00&quot;),&quot;PM&quot;: (&quot;15:00&quot;, &quot;19:00&quot;)}},</span>
<span class="sd">                    &#39;ML_lanes&#39; : {&#39;v&#39;:&#39;ML_lanes&#39;, &#39;times_periods&#39;:{&quot;AM&quot;: (&quot;6:00&quot;, &quot;10:00&quot;),&quot;PM&quot;: (&quot;15:00&quot;, &quot;19:00&quot;)}},</span>
<span class="sd">                    &#39;use&#39; : {&#39;v&#39;:&#39;use&#39;, &#39;times_periods&#39;:{&quot;AM&quot;: (&quot;6:00&quot;, &quot;10:00&quot;),&quot;PM&quot;: (&quot;15:00&quot;, &quot;19:00&quot;)}},</span>
<span class="sd">                }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">itertools</span>

        <span class="k">if</span> <span class="n">properties_to_split</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">properties_to_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">properties_to_split</span>

        <span class="k">for</span> <span class="n">out_var</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">properties_to_split</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Specified variable to split: </span><span class="si">{}</span><span class="s2"> not in network variables: </span><span class="si">{}</span><span class="s2">. Returning 0.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_periods&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">time_suffix</span><span class="p">,</span> <span class="n">category_suffix</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
                        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_periods&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
                            <span class="n">out_var</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">time_suffix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">category_suffix</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_periods&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">time_suffix</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_periods&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">out_var</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">time_suffix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_periods&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">time_suffix</span><span class="p">,</span> <span class="n">category_suffix</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_periods&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
                        <span class="n">out_var</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">category_suffix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">time_suffix</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property_by_time_period_and_group</span><span class="p">(</span>
                        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span>
                        <span class="n">category</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">][</span><span class="n">category_suffix</span><span class="p">],</span>
                        <span class="n">time_period</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_periods&quot;</span><span class="p">][</span><span class="n">time_suffix</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_periods&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">time_suffix</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_periods&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
                        <span class="n">out_var</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">time_suffix</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property_by_time_period_and_group</span><span class="p">(</span>
                        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span>
                        <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">time_period</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;time_periods&quot;</span><span class="p">][</span><span class="n">time_suffix</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Shoudn&#39;t have a category without a time period: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.create_calculated_variables"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.create_calculated_variables">[docs]</a>    <span class="k">def</span> <span class="nf">create_calculated_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates calculated roadway variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating calculated roadway variables.&quot;</span><span class="p">)</span>

        <span class="c1">#MTC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ML_variable</span><span class="p">()</span>
        <span class="c1">#/MTC</span>
        <span class="c1">#MC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_area_type</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_county</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mpo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_counts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ML_variable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_hov_corridor_variable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_managed_variable</span><span class="p">()</span></div>
        <span class="c1">#/MC</span>

<div class="viewcode-block" id="ModelRoadwayNetwork.calculate_county"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.calculate_county">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_county</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">county_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">county_shape_variable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;county&quot;</span><span class="p">,</span>
        <span class="n">county_codes_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #MC</span>
<span class="sd">        Calculates county variable.</span>

<span class="sd">        This uses the centroid of the geometry field to determine which county it should be labeled.</span>
<span class="sd">        This isn&#39;t perfect, but it much quicker than other methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            county_shape (str): The File path to county geodatabase.</span>
<span class="sd">            county_shape_variable (str): The variable name of county in county geodadabase.</span>
<span class="sd">            network_variable (str): The variable name of county in network standard.  Default to &quot;county&quot;.</span>
<span class="sd">            overwrite (Bool): True if overwriting existing county variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing County Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;County Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">county_shape</span> <span class="o">=</span> <span class="n">county_shape</span> <span class="k">if</span> <span class="n">county_shape</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">county_shape</span>

        <span class="n">county_shape_variable</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">county_shape_variable</span>
            <span class="k">if</span> <span class="n">county_shape_variable</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">county_variable_shp</span>
        <span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Adding roadway network variable for county using a spatial join with: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">county_shape</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">county_codes_dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">county_codes_dict</span> <span class="k">if</span> <span class="n">county_codes_dict</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">county_code_dict</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">county_codes_dict</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No county codes dictionary specified&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">centroids_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">centroids_gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids_gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span>

        <span class="n">county_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">county_shape</span><span class="p">)</span>
        <span class="n">county_gdf</span> <span class="o">=</span> <span class="n">county_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">joined_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">centroids_gdf</span><span class="p">,</span> <span class="n">county_gdf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>

        <span class="n">joined_gdf</span><span class="p">[</span><span class="n">county_shape_variable</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">joined_gdf</span><span class="p">[</span><span class="n">county_shape_variable</span><span class="p">]</span>
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">county_codes_dict</span><span class="p">)</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">joined_gdf</span><span class="p">[</span><span class="n">county_shape_variable</span><span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished Calculating county variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.calculate_area_type"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.calculate_area_type">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_area_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">area_type_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">area_type_shape_variable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;area_type&quot;</span><span class="p">,</span>
        <span class="n">area_type_codes_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">downtown_area_type_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">downtown_area_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #MC</span>
<span class="sd">        Calculates area type variable.</span>

<span class="sd">        This uses the centroid of the geometry field to determine which area it should be labeled.</span>
<span class="sd">        This isn&#39;t perfect, but it much quicker than other methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            area_type_shape (str): The File path to area geodatabase.</span>
<span class="sd">            area_type_shape_variable (str): The variable name of area type in area geodadabase.</span>
<span class="sd">            network_variable (str): The variable name of area type in network standard.  Default to &quot;area_type&quot;.</span>
<span class="sd">            area_type_codes_dict: The dictionary to map input area_type_shape_variable to network_variable</span>
<span class="sd">            downtown_area_type_shape: The file path to the downtown area type boundary.</span>
<span class="sd">            downtown_area_type (int): Integer value of downtown area type</span>
<span class="sd">            overwrite (Bool): True if overwriting existing county variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing Area Type Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Area Type Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Calculating Area Type from Spatial Data and adding as roadway network variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">network_variable</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">area_type_shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">area_type_shape</span> <span class="k">if</span> <span class="n">area_type_shape</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">area_type_shape</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">area_type_shape</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No area type shape specified&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">area_type_shape</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;File not found for area type shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">area_type_shape</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">area_type_shape_variable</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">area_type_shape_variable</span>
            <span class="k">if</span> <span class="n">area_type_shape_variable</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">area_type_variable_shp</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">area_type_shape_variable</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No area type shape varible specified&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">area_type_codes_dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">area_type_codes_dict</span>
            <span class="k">if</span> <span class="n">area_type_codes_dict</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">area_type_code_dict</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">area_type_codes_dict</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No area type codes dictionary specified&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">downtown_area_type_shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">downtown_area_type_shape</span>
            <span class="k">if</span> <span class="n">downtown_area_type_shape</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">downtown_area_type_shape</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">downtown_area_type_shape</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No downtown area type shape specified&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">downtown_area_type_shape</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;File not found for downtown area type shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">downtown_area_type_shape</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">downtown_area_type</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">downtown_area_type</span>
            <span class="k">if</span> <span class="n">downtown_area_type</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">downtown_area_type</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">downtown_area_type</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No downtown area type value specified&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">centroids_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">centroids_gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids_gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading Area Type Shapefile </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">area_type_shape</span><span class="p">))</span>
        <span class="n">area_type_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">area_type_shape</span><span class="p">)</span>
        <span class="n">area_type_gdf</span> <span class="o">=</span> <span class="n">area_type_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="n">downtown_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">downtown_area_type_shape</span><span class="p">)</span>
        <span class="n">downtown_gdf</span> <span class="o">=</span> <span class="n">downtown_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="n">joined_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
            <span class="n">centroids_gdf</span><span class="p">,</span> <span class="n">area_type_gdf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span>
        <span class="p">)</span>

        <span class="n">joined_gdf</span><span class="p">[</span><span class="n">area_type_shape_variable</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">joined_gdf</span><span class="p">[</span><span class="n">area_type_shape_variable</span><span class="p">]</span>
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">area_type_codes_dict</span><span class="p">)</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Area Type Codes Used: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">area_type_codes_dict</span><span class="p">))</span>

        <span class="n">d_joined_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
            <span class="n">centroids_gdf</span><span class="p">,</span> <span class="n">downtown_gdf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span>
        <span class="p">)</span>

        <span class="n">d_joined_gdf</span><span class="p">[</span><span class="s2">&quot;downtown_area_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_joined_gdf</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">joined_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">d_joined_gdf</span><span class="p">[</span><span class="s2">&quot;downtown_area_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">area_type_shape_variable</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">downtown_area_type</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Downtown Area Type used boundary file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">downtown_area_type_shape</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">joined_gdf</span><span class="p">[</span><span class="n">area_type_shape_variable</span><span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished Calculating Area Type from Spatial Data into variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">network_variable</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.calculate_mpo"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.calculate_mpo">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_mpo</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">county_network_variable</span><span class="o">=</span><span class="s2">&quot;county&quot;</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;mpo&quot;</span><span class="p">,</span>
        <span class="n">as_integer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mpo_counties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates mpo variable.</span>
<span class="sd">        #MC</span>
<span class="sd">        Args:</span>
<span class="sd">            county_variable (str): Name of the variable where the county names are stored.  Default to &quot;county&quot;.</span>
<span class="sd">            network_variable (str): Name of the variable that should be written to.  Default to &quot;mpo&quot;.</span>
<span class="sd">            as_integer (bool): If true, will convert true/false to 1/0s.</span>
<span class="sd">            mpo_counties (list): List of county names that are within mpo region.</span>
<span class="sd">            overwrite (Bool): True if overwriting existing county variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing MPO Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;MPO Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Calculating MPO as roadway network variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">county_network_variable</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">county_network_variable</span>
            <span class="k">if</span> <span class="n">county_network_variable</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">county_network_variable</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">county_network_variable</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No variable specified as containing &#39;county&#39; in the network.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">county_network_variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Specified county network variable: </span><span class="si">{}</span><span class="s2"> does not exist in network. Try running or debuging county calculation.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mpo_counties</span> <span class="o">=</span> <span class="n">mpo_counties</span> <span class="k">if</span> <span class="n">mpo_counties</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mpo_counties</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mpo_counties</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No MPO Counties specified in method call or in parameters.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MPO Counties: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mpo_counties</span><span class="p">))))</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mpo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">county_network_variable</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mpo_counties</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">as_integer</span><span class="p">:</span>
            <span class="n">mpo</span> <span class="o">=</span> <span class="n">mpo</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpo</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished calculating MPO variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.add_variable_using_shst_reference"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.add_variable_using_shst_reference">[docs]</a>    <span class="k">def</span> <span class="nf">add_variable_using_shst_reference</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_shst_csvdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shst_csv_variable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">network_var_type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join network links with source data, via SHST API node match result.</span>

<span class="sd">        Args:</span>
<span class="sd">            var_shst_csvdata (str): File path to SHST API return.</span>
<span class="sd">            shst_csv_variable (str): Variable name in the source data.</span>
<span class="sd">            network_variable (str): Name of the variable that should be written to.</span>
<span class="sd">            network_var_type : Variable type in the written network.</span>
<span class="sd">            overwrite (bool): True is overwriting existing variable. Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Adding Variable </span><span class="si">{}</span><span class="s2"> using Shared Streets Reference from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">network_variable</span><span class="p">,</span> <span class="n">var_shst_csvdata</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">var_shst_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">var_shst_csvdata</span><span class="p">)</span>
        <span class="c1"># there are aadt = 0 in the counts, drop them</span>
        <span class="n">var_shst_df</span> <span class="o">=</span> <span class="n">var_shst_df</span><span class="p">[</span><span class="n">var_shst_df</span><span class="p">[</span><span class="n">shst_csv_variable</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># count station to shared street match - there are many-to-one matches, keep just one match</span>
        <span class="n">var_shst_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;shstReferenceId&quot;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;shstReferenceId&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_shst_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&#39;shstReferenceId&#39; required but not found in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_shst_data</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shst_csv_variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_shst_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> required but not found in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">shst_csv_variable</span><span class="p">,</span> <span class="n">var_shst_data</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">join_gdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">,</span>
            <span class="n">var_shst_df</span><span class="p">[[</span><span class="s2">&quot;shstReferenceId&quot;</span><span class="p">,</span> <span class="n">shst_csv_variable</span><span class="p">]],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;shstReferenceId&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">join_gdf</span><span class="p">[</span><span class="n">shst_csv_variable</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">join_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">join_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">join_gdf</span><span class="p">[</span>
                <span class="n">shst_csv_variable</span>
            <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">network_var_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">join_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">join_gdf</span><span class="p">[</span><span class="n">shst_csv_variable</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">network_var_type</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">join_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span>

        <span class="c1"># MN and WI counts are vehicles using the segment in both directions, no directional counts</span>
        <span class="c1"># we will make sure both direction has the same daily AADT</span>
        <span class="n">dir_link_count_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;drive_access&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">network_variable</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">reverse_dir_link_count_df</span> <span class="o">=</span> <span class="n">dir_link_count_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span><span class="s2">&quot;A&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">link_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">dir_link_count_df</span><span class="p">,</span> <span class="n">reverse_dir_link_count_df</span><span class="p">],</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">link_count_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">network_variable</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">link_count_df</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">network_variable</span><span class="p">]],</span>
            <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Added variable: </span><span class="si">{}</span><span class="s2"> using Shared Streets Reference&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.add_counts"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.add_counts">[docs]</a>    <span class="k">def</span> <span class="nf">add_counts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;AADT&quot;</span><span class="p">,</span>
        <span class="n">mndot_count_shst_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">widot_count_shst_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mndot_count_variable_shp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">widot_count_variable_shp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds count variable.</span>
<span class="sd">        #MC</span>
<span class="sd">        join the network with count node data, via SHST API node match result</span>

<span class="sd">        Args:</span>
<span class="sd">            network_variable (str): Name of the variable that should be written to.  Default to &quot;AADT&quot;.</span>
<span class="sd">            mndot_count_shst_data (str): File path to MNDOT count location SHST API node match result.</span>
<span class="sd">            widot_count_shst_data (str): File path to WIDOT count location SHST API node match result.</span>
<span class="sd">            mndot_count_variable_shp (str): File path to MNDOT count location geodatabase.</span>
<span class="sd">            widot_count_variable_shp (str): File path to WIDOT count location geodatabase.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding Counts&quot;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mndot_count_shst_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mndot_count_shst_data</span>
            <span class="k">if</span> <span class="n">mndot_count_shst_data</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mndot_count_shst_data</span>
        <span class="p">)</span>
        <span class="n">widot_count_shst_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">widot_count_shst_data</span>
            <span class="k">if</span> <span class="n">widot_count_shst_data</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">widot_count_shst_data</span>
        <span class="p">)</span>
        <span class="n">mndot_count_variable_shp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mndot_count_variable_shp</span>
            <span class="k">if</span> <span class="n">mndot_count_variable_shp</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mndot_count_variable_shp</span>
        <span class="p">)</span>
        <span class="n">widot_count_variable_shp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">widot_count_variable_shp</span>
            <span class="k">if</span> <span class="n">widot_count_variable_shp</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">widot_count_variable_shp</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;mndot_count_shst_data&quot;</span><span class="p">:</span> <span class="n">mndot_count_shst_data</span><span class="p">,</span>
            <span class="s2">&quot;widot_count_shst_data&quot;</span><span class="p">:</span> <span class="n">widot_count_shst_data</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; not found in method or lasso parameters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&#39; not found at following location: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;mndot_count_variable_shp&quot;</span><span class="p">:</span> <span class="n">mndot_count_variable_shp</span><span class="p">,</span>
            <span class="s2">&quot;widot_count_variable_shp&quot;</span><span class="p">:</span> <span class="n">widot_count_variable_shp</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; not found in method or lasso parameters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Adding MNDOT Counts using </span><span class="se">\n</span><span class="s2">- shst file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">- shp file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">- as network variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mndot_count_shst_data</span><span class="p">,</span> <span class="n">mndot_count_variable_shp</span><span class="p">,</span> <span class="n">network_variable</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Add Minnesota Counts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_variable_using_shst_reference</span><span class="p">(</span>
            <span class="n">var_shst_csvdata</span><span class="o">=</span><span class="n">mndot_count_shst_data</span><span class="p">,</span>
            <span class="n">shst_csv_variable</span><span class="o">=</span><span class="n">mndot_count_variable_shp</span><span class="p">,</span>
            <span class="n">network_variable</span><span class="o">=</span><span class="n">network_variable</span><span class="p">,</span>
            <span class="n">network_var_type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Adding WiDot Counts using </span><span class="se">\n</span><span class="s2">- shst file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">- shp file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">- as network variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">widot_count_shst_data</span><span class="p">,</span> <span class="n">widot_count_variable_shp</span><span class="p">,</span> <span class="n">network_variable</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Add Wisconsin Counts, but don&#39;t overwrite Minnesota</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_variable_using_shst_reference</span><span class="p">(</span>
            <span class="n">var_shst_csvdata</span><span class="o">=</span><span class="n">widot_count_shst_data</span><span class="p">,</span>
            <span class="n">shst_csv_variable</span><span class="o">=</span><span class="n">widot_count_variable_shp</span><span class="p">,</span>
            <span class="n">network_variable</span><span class="o">=</span><span class="n">network_variable</span><span class="p">,</span>
            <span class="n">network_var_type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;count_AM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;count_MD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;count_PM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;count_NT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;count_daily&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span>
        <span class="c1"># add COUNTYEAR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;count_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2017</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished adding counts variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.read_match_result"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.read_match_result">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_match_result</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the shst geojson match returns.</span>

<span class="sd">        Returns shst dataframe.</span>

<span class="sd">        Reading lots of same type of file and concatenating them into a single DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): File path to SHST match results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            geodataframe: geopandas geodataframe</span>

<span class="sd">        ##todo</span>
<span class="sd">        not sure why we need, but should be in utilities not this class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refId_gdf</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">refid_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">refid_file</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">refId_gdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">refId_gdf</span><span class="p">,</span> <span class="n">new</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">refId_gdf</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.get_attribute"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.get_attribute">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span>
        <span class="n">links_df</span><span class="p">,</span>
        <span class="n">join_key</span><span class="p">,</span>  <span class="c1"># either &quot;shstReferenceId&quot;, or &quot;shstGeometryId&quot;, tests showed the latter gave better coverage</span>
        <span class="n">source_shst_ref_df</span><span class="p">,</span>  <span class="c1"># source shst refId</span>
        <span class="n">source_gdf</span><span class="p">,</span>  <span class="c1"># source dataframe</span>
        <span class="n">field_name</span><span class="p">,</span>  <span class="c1"># , # targetted attribute from source</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets attribute from source data using SHST match result.</span>

<span class="sd">        Args:</span>
<span class="sd">            links_df (dataframe): The network dataframe that new attribute should be written to.</span>
<span class="sd">            join_key (str): SHST ID variable name used to join source data with network dataframe.</span>
<span class="sd">            source_shst_ref_df (str): File path to source data SHST match result.</span>
<span class="sd">            source_gdf (str): File path to source data.</span>
<span class="sd">            field_name (str): Name of the attribute to get from source data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># join based on shared streets geometry ID</span>
        <span class="c1"># pp_link_id is shared streets match return</span>
        <span class="c1"># source_ink_id is mrcc</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;source ShSt rename_variables_for_dbf columns</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">source_shst_ref_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;source gdf columns</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="c1"># end up with OSM network with the MRCC Link ID</span>
        <span class="c1"># could also do with route_sys...would that be quicker?</span>
        <span class="n">join_refId_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">links_df</span><span class="p">,</span>
            <span class="n">source_shst_ref_df</span><span class="p">[[</span><span class="n">join_key</span><span class="p">,</span> <span class="s2">&quot;pp_link_id&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pp_link_id&quot;</span><span class="p">:</span> <span class="s2">&quot;source_link_id&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="s2">&quot;source_score&quot;</span><span class="p">}</span>
            <span class="p">),</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">join_key</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># joined with MRCC dataframe to get route_sys</span>

        <span class="n">join_refId_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">join_refId_df</span><span class="p">,</span>
            <span class="n">source_gdf</span><span class="p">[[</span><span class="s2">&quot;LINK_ID&quot;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;LINK_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;source_link_id&quot;</span><span class="p">}</span>
            <span class="p">),</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;source_link_id&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># drop duplicated records with same field value</span>

        <span class="n">join_refId_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">,</span> <span class="s2">&quot;shstReferenceId&quot;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># more than one match, take the best score</span>

        <span class="n">join_refId_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">,</span> <span class="s2">&quot;source_score&quot;</span><span class="p">],</span>
            <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">na_position</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">join_refId_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># self.links_df[field_name] = join_refId_df[field_name]</span>

        <span class="k">return</span> <span class="n">join_refId_df</span><span class="p">[</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">field_name</span><span class="p">,</span> <span class="s2">&quot;source_link_id&quot;</span><span class="p">]]</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.calculate_use"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.calculate_use">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_use</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;use&quot;</span><span class="p">,</span>
        <span class="n">as_integer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates use variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            network_variable (str): Variable that should be written to in the network. Default to &quot;use&quot;</span>
<span class="sd">            as_integer (bool): If True, will convert true/false to 1/0s.  Defauly to True.</span>
<span class="sd">            overwrite (Bool): True if overwriting existing county variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing hov Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;use&#39; Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Calculating hov and adding as roadway network variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">network_variable</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">network_variable</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No network variable specified for centroid connector&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#MTC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#/MTC</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;assign_group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;hov&quot;</span><span class="p">),</span>
            <span class="n">network_variable</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="c1">#/MC</span>


        <span class="k">if</span> <span class="n">as_integer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="nb">int</span>
            <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished calculating hov variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.create_ML_variable"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.create_ML_variable">[docs]</a>    <span class="k">def</span> <span class="nf">create_ML_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;ML_lanes&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Created ML lanes placeholder for project to write out ML changes</span>

<span class="sd">        ML lanes default to 0, ML info comes from cube LOG file and store in project cards</span>

<span class="sd">        Args:</span>
<span class="sd">            overwrite (Bool): True if overwriting existing variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing ML Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;ML Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished creating ML lanes variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.create_hov_corridor_variable"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.create_hov_corridor_variable">[docs]</a>    <span class="k">def</span> <span class="nf">create_hov_corridor_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;segment_id&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Created hov corridor placeholder for project to write out corridor changes</span>

<span class="sd">        hov corridor id default to 0, its info comes from cube LOG file and store in project cards</span>

<span class="sd">        Args:</span>
<span class="sd">            overwrite (Bool): True if overwriting existing variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing hov corridor Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Hov corridor Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished creating hov corridor variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.create_managed_variable"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.create_managed_variable">[docs]</a>    <span class="k">def</span> <span class="nf">create_managed_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;managed&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Created placeholder for project to write out managed</span>

<span class="sd">        managed default to 0, its info comes from cube LOG file and store in project cards</span>

<span class="sd">        Args:</span>
<span class="sd">            overwrite (Bool): True if overwriting existing variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing managed Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Managed Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished creating managed variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.calculate_centroidconnect"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.calculate_centroidconnect">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_centroidconnect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;centroidconnect&quot;</span><span class="p">,</span>
        <span class="n">highest_taz_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">as_integer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates centroid connector variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            parameters (Parameters): A Lasso Parameters, which stores input files.</span>
<span class="sd">            network_variable (str): Variable that should be written to in the network. Default to &quot;centroidconnect&quot;</span>
<span class="sd">            highest_taz_number (int): the max TAZ number in the network.</span>
<span class="sd">            as_integer (bool): If True, will convert true/false to 1/0s.  Default to True.</span>
<span class="sd">            overwrite (Bool): True if overwriting existing county variable in network.  Default to False.</span>
<span class="sd">        Returns:</span>
<span class="sd">            RoadwayNetwork</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing Centroid Connector Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Centroid Connector Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Calculating Centroid Connector and adding as roadway network variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">network_variable</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">highest_taz_number</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">highest_taz_number</span> <span class="k">if</span> <span class="n">highest_taz_number</span> <span class="k">else</span> <span class="n">parameters</span><span class="o">.</span><span class="n">highest_taz_number</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">highest_taz_number</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No highest_TAZ number specified in method variable or in parameters&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Calculating Centroid Connectors using highest TAZ number: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">highest_taz_number</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">network_variable</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No network variable specified for centroid connector&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">highest_taz_number</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">highest_taz_number</span><span class="p">),</span>
            <span class="n">network_variable</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">as_integer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
                <span class="n">network_variable</span>
            <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished calculating centroid connector variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ModelRoadwayNetwork.calculate_distance"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.calculate_distance">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_distance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">network_variable</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="n">centroidconnect_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate link distance in miles</span>

<span class="sd">        Args:</span>
<span class="sd">            centroidconnect_only (Bool):  True if calculating distance for centroidconnectors only.  Default to False.</span>
<span class="sd">            overwrite (Bool): True if overwriting existing variable in network.  Default to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">network_variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Overwriting existing distance Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Distance Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; already in network. Returning without overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network_variable</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#MC</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;centroidconnect&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s2">&quot;taz&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">roadway</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">centroidconnect_only</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No variable specified for centroid connector, calculating centroidconnect first&quot;</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>           
        <span class="c1">#/MC</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">temp_links_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>
        <span class="n">temp_links_gdf</span> <span class="o">=</span> <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">26915</span><span class="p">)</span>

        <span class="c1">#MTC</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Calculating distance for all links&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">temp_links_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mf">1609.34</span>
        <span class="c1">#/MTC</span>
        <span class="c1">#MC</span>
        <span class="k">if</span> <span class="n">centroidconnect_only</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Calculating </span><span class="si">{}</span><span class="s2"> for centroid connectors&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">temp_links_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">centroidconnect</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mf">1609.34</span><span class="p">,</span>
                <span class="n">temp_links_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Calculating distance for all links&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network_variable</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">temp_links_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mf">1609.34</span>
        <span class="c1">#/MC</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_links_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.convert_int"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.convert_int">[docs]</a>    <span class="k">def</span> <span class="nf">convert_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">int_col_names</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert integer columns</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#MTC</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Converting variable type to mtc standard&quot;</span>
        <span class="p">)</span>

        <span class="n">int_col_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">int_col</span>
        <span class="c1">#/MTC</span>
        <span class="c1">#MC</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        WranglerLogger.info(&quot;Converting variable type to MetCouncil standard&quot;)</span>

<span class="sd">        if not int_col_names:</span>
<span class="sd">            int_col_names = self.parameters.int_col</span>
<span class="sd">        #/MC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">##Why are we doing this?</span>
        <span class="c1"># int_col_names.remove(&quot;lanes&quot;)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">int_col_names</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># REPLACE BLANKS WITH ZERO FOR INTEGER COLUMNS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Could not convert column </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> to integer.&quot;</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">int_col_names</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.fill_na"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.fill_na">[docs]</a>    <span class="k">def</span> <span class="nf">fill_na</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill na values from create_managed_lane_network()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filling nan for network from network wrangler&quot;</span><span class="p">)</span>

        <span class="n">num_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">int_col</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">float_col</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">num_col</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span> <span class="s2">&quot;NaN&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">k</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">num_col</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ModelRoadwayNetwork.roadway_standard_to_met_council_network"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.roadway_standard_to_met_council_network">[docs]</a>    <span class="k">def</span> <span class="nf">roadway_standard_to_met_council_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_epsg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename and format roadway attributes to be consistent with what metcouncil&#39;s model is expecting.</span>
<span class="sd">        #MC</span>
<span class="sd">        Args:</span>
<span class="sd">            output_epsg (int): epsg number of output network.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Renaming roadway attributes to be consistent with what metcouncil&#39;s model is expecting&quot;</span>
        <span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output_epsg</span> <span class="o">=</span> <span class="n">output_epsg</span> <span class="k">if</span> <span class="n">output_epsg</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_epsg</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;managed&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating managed lane network.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_managed_lane_network</span><span class="p">(</span><span class="n">in_place</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># when ML and assign_group projects are applied together, assign_group is filled as &quot;&quot; by wrangler for ML links</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ModelRoadwayNetwork</span><span class="o">.</span><span class="n">CALCULATED_VALUES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">int_col</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Didn&#39;t detect managed lanes in network.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_centroidconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_calculated_variables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_distance</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fill_na</span><span class="p">()</span>
        <span class="c1"># no method to calculate price yet, will be hard coded in project card</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Splitting variables by time period and category&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_properties_by_time_period_and_category</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_int</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_metcouncil_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_metcouncil_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_metcouncil_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">),</span>  <span class="c1"># drop the stick geometry in links_df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="p">[[</span><span class="s2">&quot;shape_id&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;shape_id&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links_metcouncil_df</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting Coordinate Reference System to EPSG 26915&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_metcouncil_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_metcouncil_df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">26915</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">26915</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">x</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">y</span>
        <span class="p">)</span>

        <span class="c1"># CUBE expect node id to be N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_metcouncil_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.rename_variables_for_dbf"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.rename_variables_for_dbf">[docs]</a>    <span class="k">def</span> <span class="nf">rename_variables_for_dbf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_df</span><span class="p">,</span>
        <span class="n">variable_crosswalk</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_variables</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">convert_geometry_to_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename attributes for DBF/SHP, make sure length within 10 chars.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_df (dataframe): Network standard DataFrame.</span>
<span class="sd">            variable_crosswalk (str): File path to variable name crosswalk from network standard to DBF names.</span>
<span class="sd">            output_variables (list): List of strings for DBF variables.</span>
<span class="sd">            convert_geometry_to_xy (bool): True if converting node geometry to X/Y</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataframe</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Renaming variables so that they are DBF-safe&quot;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">variable_crosswalk</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">variable_crosswalk</span>
            <span class="k">if</span> <span class="n">variable_crosswalk</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">net_to_dbf_crosswalk</span>
        <span class="p">)</span>

        <span class="n">output_variables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output_variables</span> <span class="k">if</span> <span class="n">output_variables</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_variables</span>
        <span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">crosswalk_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">variable_crosswalk</span><span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Variable crosswalk: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable_crosswalk</span><span class="p">,</span> <span class="n">crosswalk_df</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">net_to_dbf_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">crosswalk_df</span><span class="p">[</span><span class="s2">&quot;net&quot;</span><span class="p">],</span> <span class="n">crosswalk_df</span><span class="p">[</span><span class="s2">&quot;dbf&quot;</span><span class="p">]))</span>

        <span class="n">dbf_name_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">dbf_df</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_df</span><span class="p">)</span>

        <span class="c1"># only write out variables that we specify</span>
        <span class="c1"># if variable is specified in the crosswalk, rename it to that variable</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dbf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">output_variables</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dbf_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">net_to_dbf_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dbf_name_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">net_to_dbf_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">dbf_name_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">in</span> <span class="n">dbf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbf_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geom_type</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Point&quot;</span><span class="p">:</span>
                <span class="n">dbf_df</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbf_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                <span class="n">dbf_df</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbf_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">dbf_name_list</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DBF Variables: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbf_name_list</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">dbf_df</span><span class="p">[</span><span class="n">dbf_name_list</span><span class="p">]</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.write_roadway_as_shp"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.write_roadway_as_shp">[docs]</a>    <span class="k">def</span> <span class="nf">write_roadway_as_shp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">node_output_variables</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">link_output_variables</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_to_csv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">data_to_dbf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">output_link_shp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_node_shp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_link_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_node_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_gpkg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_link_gpkg_layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_node_gpkg_layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_gpkg_link_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out dbf/shp/gpkg for cube.  Write out csv in addition to shp with full length variable names.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (str): File path to directory</span>
<span class="sd">            node_output_variables (list): List of strings for node output variables.</span>
<span class="sd">            link_output_variables (list): List of strings for link output variables.</span>
<span class="sd">            data_to_csv (bool): True if write network in csv format.</span>
<span class="sd">            data_to_dbf (bool): True if write network in dbf/shp format.</span>
<span class="sd">            output_link_shp (str): File name to output link dbf/shp.</span>
<span class="sd">            output_node_shp (str): File name of output node dbf/shp.</span>
<span class="sd">            output_link_csv (str): File name to output link csv.</span>
<span class="sd">            output_node_csv (str): File name to output node csv.</span>
<span class="sd">            output_gpkg (str): File name to output GeoPackage.</span>
<span class="sd">            output_link_gpkg_layer (str): Layer name within output_gpkg to output links.</span>
<span class="sd">            output_node_gpkg_layer (str): Layer name within output_gpkg to output links.</span>
<span class="sd">            output_gpkg_link_filter (str): Optional column name to additional output link subset layers</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing Network as Shapefile&quot;</span><span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Output Variables: </span><span class="se">\n</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_variables</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roadway_standard_to_met_council_network</span><span class="p">()</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Network Link Variables: </span><span class="se">\n</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Network Node Variables: </span><span class="se">\n</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">link_output_variables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">link_output_variables</span>
            <span class="k">if</span> <span class="n">link_output_variables</span>
            <span class="k">else</span> <span class="p">[</span>
                <span class="n">c</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_variables</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">node_output_variables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">node_output_variables</span>
            <span class="k">if</span> <span class="n">node_output_variables</span>
            <span class="k">else</span> <span class="p">[</span>
                <span class="n">c</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_variables</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># unless specified that all the data goes to the DBF, only output A and B</span>
        <span class="n">dbf_link_output_variables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1">#MTC</span>
            <span class="n">link_output_variables</span> <span class="k">if</span> <span class="n">link_output_variables</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
            <span class="c1">#MC</span>
            <span class="c1">#link_output_variables if data_to_dbf else [&quot;A&quot;, &quot;B&quot;, &quot;shape_id&quot;, &quot;geometry&quot;]</span>
        <span class="p">)</span>

        <span class="c1"># Removing code to set this to versions from parameters</span>
        <span class="c1"># User can use these as arg</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start Process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># rename these to short only for shapefile option</span>
        <span class="k">if</span> <span class="n">output_node_shp</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Renaming DBF Node Variables&quot;</span><span class="p">)</span>
            <span class="n">nodes_dbf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_variables_for_dbf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="p">,</span> <span class="n">output_variables</span><span class="o">=</span><span class="n">node_output_variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;nodes_mtc_df columns: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
            <span class="n">nodes_dbf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="p">[</span><span class="n">node_output_variables</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">output_link_shp</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Renaming DBF Link Variables&quot;</span><span class="p">)</span>
            <span class="n">links_dbf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_variables_for_dbf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="p">,</span> <span class="n">output_variables</span><span class="o">=</span><span class="n">dbf_link_output_variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;links_mtc_df columns: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
            <span class="n">links_dbf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="p">[</span><span class="n">dbf_link_output_variables</span><span class="p">]</span>

        <span class="n">links_dbf_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">links_dbf_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">links_dbf_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>

        <span class="c1"># temp debug</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;links_dbf_df.loc[(links_dbf_df.A.isin([7063066,2563066]))|(links_dbf_df.B.isin([7063066,2563066]))]:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">links_dbf_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">links_dbf_df</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">7063066</span><span class="p">,</span><span class="mi">2563066</span><span class="p">]))</span><span class="o">|</span><span class="p">(</span><span class="n">links_dbf_df</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">7063066</span><span class="p">,</span><span class="mi">2563066</span><span class="p">]))]</span>
        <span class="p">))</span>

        <span class="k">if</span> <span class="n">output_node_shp</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing Node Shapes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_node_shp</span><span class="p">)))</span>
            <span class="n">nodes_dbf_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_node_shp</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">output_gpkg</span> <span class="ow">and</span> <span class="n">output_node_gpkg_layer</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing GeoPackage </span><span class="si">{}</span><span class="s2"> with Node Layer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_gpkg</span><span class="p">),</span> <span class="n">output_node_gpkg_layer</span><span class="p">))</span>
            <span class="n">nodes_dbf_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_gpkg</span><span class="p">),</span> <span class="n">layer</span><span class="o">=</span><span class="n">output_node_gpkg_layer</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_link_shp</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing Link Shapes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_link_shp</span><span class="p">)))</span>
            <span class="n">links_dbf_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_link_shp</span><span class="p">))</span>

        <span class="c1"># debug test</span>
        <span class="n">link_schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;A&quot;</span>             <span class="p">:</span> <span class="s2">&quot;int:8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;B&quot;</span>             <span class="p">:</span> <span class="s2">&quot;int:8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;model_link_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;int:10&quot;</span><span class="p">,</span>
                <span class="s2">&quot;shstGeometryId&quot;</span><span class="p">:</span> <span class="s2">&quot;str:32&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span>          <span class="p">:</span> <span class="s2">&quot;str:84&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ft&quot;</span>            <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;assignable&quot;</span>    <span class="p">:</span> <span class="s2">&quot;int:18&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cntype&quot;</span>        <span class="p">:</span> <span class="s2">&quot;str:80&quot;</span><span class="p">,</span>
                <span class="s2">&quot;distance&quot;</span>      <span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                <span class="s2">&quot;county&quot;</span>        <span class="p">:</span> <span class="s2">&quot;str:15&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bike_access&quot;</span>   <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;drive_access&quot;</span>  <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;walk_access&quot;</span>   <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rail_only&quot;</span>     <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bus_only&quot;</span>      <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;transit&quot;</span>       <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;managed&quot;</span>       <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tollbooth&quot;</span>     <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tollseg&quot;</span>       <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;segment_id&quot;</span>    <span class="p">:</span> <span class="s2">&quot;int:4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lanes_EA&quot;</span>      <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>                
                <span class="s2">&quot;heuristic_num&quot;</span> <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lanes_AM&quot;</span>      <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lanes_MD&quot;</span>      <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lanes_PM&quot;</span>      <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lanes_EV&quot;</span>      <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;useclass_EA&quot;</span>   <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;useclass_AM&quot;</span>   <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;useclass_MD&quot;</span>   <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;useclass_PM&quot;</span>   <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;useclass_EV&quot;</span>   <span class="p">:</span> <span class="s2">&quot;int:2&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;LineString&quot;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">output_gpkg</span> <span class="ow">and</span> <span class="n">output_link_gpkg_layer</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing GeoPackage </span><span class="si">{}</span><span class="s2"> with Link Layer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_gpkg</span><span class="p">),</span> <span class="n">output_link_gpkg_layer</span><span class="p">))</span>
            <span class="n">links_dbf_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_gpkg</span><span class="p">),</span> <span class="n">layer</span><span class="o">=</span><span class="n">output_link_gpkg_layer</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">link_schema</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>

            <span class="c1"># output additional link layers if filter column is specified</span>
            <span class="c1"># e.g. if county-subsets are output</span>
            <span class="k">if</span> <span class="n">output_gpkg_link_filter</span><span class="p">:</span>
                <span class="n">link_value_counts</span> <span class="o">=</span> <span class="n">links_dbf_df</span><span class="p">[</span><span class="n">output_gpkg_link_filter</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">filter_val</span><span class="p">,</span><span class="n">filter_count</span> <span class="ow">in</span> <span class="n">link_value_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">gpkg_layer_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_link_gpkg_layer</span><span class="p">,</span> <span class="n">filter_val</span><span class="p">)</span>
                    <span class="n">gpkg_layer_name</span> <span class="o">=</span> <span class="n">gpkg_layer_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing GeoPackage </span><span class="si">{}</span><span class="s2"> with Link Layer </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2"> rows&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_gpkg</span><span class="p">),</span> <span class="n">gpkg_layer_name</span><span class="p">,</span> <span class="n">filter_count</span><span class="p">))</span>
                    <span class="n">links_dbf_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">links_dbf_df</span><span class="p">[</span><span class="n">output_gpkg_link_filter</span><span class="p">]</span><span class="o">==</span><span class="n">filter_val</span> <span class="p">]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_gpkg</span><span class="p">),</span> <span class="n">layer</span><span class="o">=</span><span class="n">gpkg_layer_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">link_schema</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>




        <span class="k">if</span> <span class="n">data_to_csv</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Writing Network Data to CSVs:</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">output_link_csv</span><span class="p">,</span> <span class="n">output_node_csv</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="p">[</span><span class="n">link_output_variables</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="n">output_link_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="p">[</span><span class="n">node_output_variables</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="n">output_node_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span></div>


    <span class="c1"># this should be moved to util</span>
<div class="viewcode-block" id="ModelRoadwayNetwork.dataframe_to_fixed_width"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.dataframe_to_fixed_width">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dataframe_to_fixed_width</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert dataframe to fixed width format, geometry column will not be transformed.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas DataFrame).</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas dataframe:  dataframe with fixed width for each column.</span>
<span class="sd">            dict: dictionary with columns names as keys, column width as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting fixed width conversion&quot;</span><span class="p">)</span>

        <span class="c1"># get the max length for each variable column</span>
        <span class="n">max_width_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;geometry&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">fw_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fw_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">fw_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">fw_df</span><span class="p">[</span><span class="s2">&quot;pad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_width_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">fw_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;pad&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fw_df</span><span class="p">,</span> <span class="n">max_width_dict</span></div>

<div class="viewcode-block" id="ModelRoadwayNetwork.write_roadway_as_fixedwidth"><a class="viewcode-back" href="../../../_generated/lasso.ModelRoadwayNetwork/#lasso.ModelRoadwayNetwork.write_roadway_as_fixedwidth">[docs]</a>    <span class="k">def</span> <span class="nf">write_roadway_as_fixedwidth</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">node_output_variables</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">link_output_variables</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_link_txt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_node_txt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_link_header_width_txt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_node_header_width_txt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_cube_network_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">drive_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes out fixed width file.</span>

<span class="sd">        This function does:</span>
<span class="sd">        1. write out link and node fixed width data files for cube.</span>
<span class="sd">        2. write out header and width correspondence.</span>
<span class="sd">        3. write out cube network building script with header and width specification.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (str): File path to where links, nodes and script will be written and run</span>
<span class="sd">            node_output_variables (list): list of node variable names.</span>
<span class="sd">            link_output_variables (list): list of link variable names.</span>
<span class="sd">            output_link_txt (str): File name of output link database (within output_dir)</span>
<span class="sd">            output_node_txt (str): File name of output node database (within output_dir)</span>
<span class="sd">            output_link_header_width_txt (str): File name of link column width records (within output_dir)</span>
<span class="sd">            output_node_header_width_txt (str): File name of node column width records (within output_dir)</span>
<span class="sd">            output_cube_network_script (str): File name of CUBE network building script (within output_dir)</span>
<span class="sd">            drive_only (bool): If True, only writes drive nodes and links</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roadway_standard_to_mtc_network</span><span class="p">()</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Network Link Variables: </span><span class="se">\n</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Network Node Variables: </span><span class="se">\n</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">link_output_variables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">link_output_variables</span>
            <span class="k">if</span> <span class="n">link_output_variables</span>
            <span class="k">else</span> <span class="p">[</span>
                <span class="n">c</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_variables</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">node_output_variables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">node_output_variables</span>
            <span class="k">if</span> <span class="n">node_output_variables</span>
            <span class="k">else</span> <span class="p">[</span>
                <span class="n">c</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_variables</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">output_link_txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output_link_txt</span> <span class="k">if</span> <span class="n">output_link_txt</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_link_txt</span>
        <span class="p">)</span>

        <span class="n">output_node_txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output_node_txt</span> <span class="k">if</span> <span class="n">output_node_txt</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_node_txt</span>
        <span class="p">)</span>

        <span class="n">output_link_header_width_txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output_link_header_width_txt</span>
            <span class="k">if</span> <span class="n">output_link_header_width_txt</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_link_header_width_txt</span>
        <span class="p">)</span>

        <span class="n">output_node_header_width_txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output_node_header_width_txt</span>
            <span class="k">if</span> <span class="n">output_node_header_width_txt</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_node_header_width_txt</span>
        <span class="p">)</span>

        <span class="n">output_cube_network_script</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output_cube_network_script</span>
            <span class="k">if</span> <span class="n">output_cube_network_script</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">output_cube_network_script</span>
        <span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start Process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#MTC</span>
        <span class="n">link_ff_df</span><span class="p">,</span> <span class="n">link_max_width_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_to_fixed_width</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="p">[</span><span class="n">link_output_variables</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">drive_only</span><span class="p">:</span>
            <span class="n">link_ff_df</span> <span class="o">=</span> <span class="n">link_ff_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_ff_df</span><span class="p">[</span><span class="s1">&#39;drive_access&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1">#/MTC</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #MC</span>
<span class="sd">        link_ff_df, link_max_width_dict = self.dataframe_to_fixed_width(</span>
<span class="sd">            self.links_metcouncil_df[link_output_variables]</span>
<span class="sd">        )</span>

<span class="sd">        if drive_only:</span>
<span class="sd">            link_ff_df = link_ff_df.loc[link_ff_df[&quot;drive_access&quot;] == 1]</span>
<span class="sd">        #/MC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing out link database&quot;</span><span class="p">)</span>

        <span class="n">link_ff_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_link_txt</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># write out header and width correspondence</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing out link header and width ----&quot;</span><span class="p">)</span>
        <span class="n">link_max_width_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">link_max_width_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">link_max_width_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_link_header_width_txt</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#MTC</span>
        <span class="n">node_ff_df</span><span class="p">,</span> <span class="n">node_max_width_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_to_fixed_width</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="p">[</span><span class="n">node_output_variables</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1">#/MTC</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #MC</span>
<span class="sd">        node_ff_df, node_max_width_dict = self.dataframe_to_fixed_width(</span>
<span class="sd">            self.nodes_metcouncil_df[node_output_variables]</span>
<span class="sd">        )</span>
<span class="sd">        #/MC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing out node database&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">drive_only</span><span class="p">:</span>
            <span class="n">node_ff_df</span> <span class="o">=</span> <span class="n">node_ff_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">node_ff_df</span><span class="p">[</span><span class="s2">&quot;drive_node&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>


        <span class="n">node_ff_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_node_txt</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># write out header and width correspondence</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing out node header and width&quot;</span><span class="p">)</span>
        <span class="n">node_max_width_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">node_max_width_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">node_max_width_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_node_header_width_txt</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># write out cube script</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;RUN PGM = NETWORK MSG = &quot;Read in network from fixed width file&quot; </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;FILEI LINKI[1] = &quot;</span><span class="si">{}</span><span class="s1">&quot;,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_link_txt</span><span class="p">)</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">link_max_width_df</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; VAR=&quot;</span> <span class="o">+</span> <span class="n">link_max_width_df</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_mtc_df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_max_width_df</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="o">==</span> <span class="s2">&quot;O&quot;</span>
            <span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;(C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">link_max_width_df</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

            <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;, BEG=&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_pos</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;, LEN=&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">link_max_width_df</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
            <span class="p">)</span>

            <span class="n">start_pos</span> <span class="o">+=</span> <span class="n">link_max_width_df</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;FILEI NODEI[1] = &quot;</span><span class="si">{}</span><span class="s1">&quot;,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_node_txt</span><span class="p">)</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_max_width_df</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; VAR=&quot;</span> <span class="o">+</span> <span class="n">node_max_width_df</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_mtc_df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">node_max_width_df</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="o">==</span> <span class="s2">&quot;O&quot;</span>
            <span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;(C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_max_width_df</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

            <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;, BEG=&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_pos</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;, LEN=&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_max_width_df</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
            <span class="p">)</span>

            <span class="n">start_pos</span> <span class="o">+=</span> <span class="n">node_max_width_df</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;FILEO NETO = &quot;complete_network.net&quot;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; ZONES = </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">zones</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;; Trim leading whitespace from string variables</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># todo: The below should be built above based on columns that are strings</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; phase=NODEMERGE</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  county = LTRIM(county)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; endphase</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; phase=LINKMERGE</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  name = LTRIM(name)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  county = LTRIM(county)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  cntype = LTRIM(cntype)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; endphase</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ENDRUN</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_cube_network_script</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
 
        <span class="c1"># run the cube script to create the cube network</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">cube_cmd</span> <span class="o">=</span> <span class="s1">&#39;&quot;C:</span><span class="se">\\</span><span class="s1">Program Files</span><span class="se">\\</span><span class="s1">Citilabs</span><span class="se">\\</span><span class="s1">CubeVoyager</span><span class="se">\\</span><span class="s1">runtpp.exe&quot; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_cube_network_script</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running [</span><span class="si">{}</span><span class="s2">] in cwd [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_cmd</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">))</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cube_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;return code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stdout: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stderr: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022 Metropolitan Council, Metropolitan Transportation Commission.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>