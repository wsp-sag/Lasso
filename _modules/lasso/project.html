

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lasso.project &mdash; lasso  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> lasso
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../starting.html">Starting Out</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running Lasso</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodoc.html">Lasso Classes and Functions</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">lasso</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>lasso.project</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lasso.project</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">csv</span> <span class="kn">import</span> <span class="n">reader</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="kn">from</span> <span class="nn">network_wrangler</span> <span class="kn">import</span> <span class="n">ProjectCard</span>
<span class="kn">from</span> <span class="nn">network_wrangler</span> <span class="kn">import</span> <span class="n">RoadwayNetwork</span>

<span class="kn">from</span> <span class="nn">.transit</span> <span class="kn">import</span> <span class="n">CubeTransit</span><span class="p">,</span> <span class="n">StandardTransit</span>
<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">WranglerLogger</span>
<span class="kn">from</span> <span class="nn">.parameters</span> <span class="kn">import</span> <span class="n">Parameters</span>
<span class="kn">from</span> <span class="nn">.roadway</span> <span class="kn">import</span> <span class="n">ModelRoadwayNetwork</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">column_name_to_parts</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A single or set of changes to the roadway or transit system.</span>

<span class="sd">    Compares a base and a build transit network or a base and build</span>
<span class="sd">    highway network and produces project cards.</span>

<span class="sd">    .. highlight:: python</span>

<span class="sd">    Typical usage example:</span>
<span class="sd">    ::</span>
<span class="sd">        test_project = Project.create_project(</span>
<span class="sd">            base_transit_source=os.path.join(CUBE_DIR, &quot;transit.LIN&quot;),</span>
<span class="sd">            build_transit_source=os.path.join(CUBE_DIR, &quot;transit_route_shape_change&quot;),</span>
<span class="sd">        )</span>
<span class="sd">        test_project.evaluate_changes()</span>
<span class="sd">        test_project.write_project_card(</span>
<span class="sd">            os.path.join(SCRATCH_DIR, &quot;t_transit_shape_test.yml&quot;)</span>
<span class="sd">        )</span>

<span class="sd">    Attributes:</span>
<span class="sd">        DEFAULT_PROJECT_NAME: a class-level constant that defines what</span>
<span class="sd">            the project name will be if none is set.</span>
<span class="sd">        STATIC_VALUES: a class-level constant which defines values that</span>
<span class="sd">            are not evaluated when assessing changes.</span>
<span class="sd">        card_data (dict):  {&quot;project&quot;: &lt;project_name&gt;, &quot;changes&quot;: &lt;list of change dicts&gt;}</span>
<span class="sd">        roadway_changes (DataFrame):  pandas dataframe of CUBE roadway changes.</span>
<span class="sd">        transit_changes (CubeTransit):</span>
<span class="sd">        base_roadway_network (RoadwayNetwork):</span>
<span class="sd">        base_transit_network (CubeTransit):</span>
<span class="sd">        build_transit_network (CubeTransit):</span>
<span class="sd">        project_name (str): name of the project, set to DEFAULT_PROJECT_NAME if not provided</span>
<span class="sd">        parameters: an  instance of the Parameters class which sets a bunch of parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEFAULT_PROJECT_NAME</span> <span class="o">=</span> <span class="s2">&quot;USER TO define&quot;</span>

    <span class="n">STATIC_VALUES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;model_link_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;area_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;county&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;assign_group&quot;,</span>
        <span class="s2">&quot;centroidconnect&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">CALCULATED_VALUES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;area_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;county&quot;</span><span class="p">,</span>
        <span class="s2">&quot;assign_group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;centroidconnect&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="Project.__init__"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">roadway_changes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transit_changes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CubeTransit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_roadway_network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RoadwayNetwork</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_transit_network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CubeTransit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">build_transit_network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CubeTransit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">evaluate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ProjectCard constructor.</span>

<span class="sd">        args:</span>
<span class="sd">            roadway_changes: dataframe of roadway changes read from a log file</span>
<span class="sd">            transit_changes:</span>
<span class="sd">            base_roadway_network: RoadwayNetwork instance for base case</span>
<span class="sd">            base_transit_network: CubeTransit instance for base transit network</span>
<span class="sd">            build_transit_network: CubeTransit instance for build transit network</span>
<span class="sd">            project_name: name of the project</span>
<span class="sd">            evaluate: defaults to false, but if true, will create card data</span>
<span class="sd">            parameters: dictionary of parameter settings (see Parameters class) or an instance of Parameters. If not specified, will use default parameters.</span>

<span class="sd">        returns: instance of ProjectCard</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">card_data</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span> <span class="o">=</span> <span class="n">roadway_changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span> <span class="o">=</span> <span class="n">base_roadway_network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_transit_network</span> <span class="o">=</span> <span class="n">base_transit_network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_transit_network</span> <span class="o">=</span> <span class="n">build_transit_network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transit_changes</span> <span class="o">=</span> <span class="n">transit_changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">project_name</span> <span class="k">if</span> <span class="n">project_name</span> <span class="k">else</span> <span class="n">Project</span><span class="o">.</span><span class="n">DEFAULT_PROJECT_NAME</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Parameters should be a dict or instance of Parameters: found </span><span class="si">{}</span><span class="s2"> which is of type:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base_roadway_network</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">determine_roadway_network_changes_compatability</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">evaluate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_changes</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.write_project_card"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.write_project_card">[docs]</a>    <span class="k">def</span> <span class="nf">write_project_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes project cards.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): File path to output .yml</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ProjectCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">card_data</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.create_project"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.create_project">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span>
        <span class="n">roadway_log_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">roadway_shp_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">roadway_csv_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_roadway_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_transit_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">build_transit_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">roadway_changes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transit_changes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CubeTransit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_roadway_network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RoadwayNetwork</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_transit_network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CubeTransit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">build_transit_network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CubeTransit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">recalculate_calculated_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">recalculate_distance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for a Project instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            roadway_log_file: File path to consuming logfile or a list of logfile paths.</span>
<span class="sd">            roadway_shp_file: File path to consuming shape file for roadway changes.</span>
<span class="sd">            roadway_csv_file: File path to consuming csv file for roadway changes.</span>
<span class="sd">            base_roadway_dir: Folder path to base roadway network.</span>
<span class="sd">            base_transit_source: Folder path to base transit network or cube line file string.</span>
<span class="sd">            base_transit_file: File path to base transit network.</span>
<span class="sd">            build_transit_source: Folder path to build transit network or cube line file string.</span>
<span class="sd">            build_transit_file: File path to build transit network.</span>
<span class="sd">            roadway_changes: pandas dataframe of CUBE roadway changes.</span>
<span class="sd">            transit_changes: build transit changes.</span>
<span class="sd">            base_roadway_network: Base roadway network object.</span>
<span class="sd">            base_transit_network: Base transit network object.</span>
<span class="sd">            build_transit_network: Build transit network object.</span>
<span class="sd">            project_name:  If not provided, will default to the roadway_log_file filename if provided (or the first filename if a list is provided)</span>
<span class="sd">            recalculate_calculated_variables: if reading in a base network, if this is true it will recalculate variables such as area type, etc. This only needs to be true if you are creating project cards that are changing the calculated variables.</span>
<span class="sd">            recalculate_distance:  recalculate the distance variable. This only needs to be true if you are creating project cards that change the distance.</span>
<span class="sd">            parameters: dictionary of parameters</span>
<span class="sd">        Returns:</span>
<span class="sd">            A Project instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">base_transit_source</span> <span class="ow">and</span> <span class="n">base_transit_network</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;base_transit_source&#39; and &#39;base_transit_network&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_transit_source</span><span class="p">:</span>
            <span class="n">base_transit_network</span> <span class="o">=</span> <span class="n">CubeTransit</span><span class="o">.</span><span class="n">create_from_cube</span><span class="p">(</span><span class="n">base_transit_source</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Base network has </span><span class="si">{}</span><span class="s2"> lines&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_transit_network</span><span class="o">.</span><span class="n">lines</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_transit_network</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Base network lines: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_transit_network</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">base_transit_network</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No base transit network.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">base_transit_network</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">build_transit_source</span> <span class="ow">and</span> <span class="n">transit_changes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;build_transit_source&#39; and &#39;transit_changes&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">build_transit_source</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;build&quot;</span><span class="p">)</span>
            <span class="n">build_transit_network</span> <span class="o">=</span> <span class="n">CubeTransit</span><span class="o">.</span><span class="n">create_from_cube</span><span class="p">(</span><span class="n">build_transit_source</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Build network has </span><span class="si">{}</span><span class="s2"> lines&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">build_transit_network</span><span class="o">.</span><span class="n">lines</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">build_transit_network</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Build network lines: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_transit_network</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">transit_changes</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No transit changes given or processed.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">transit_changes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">roadway_log_file</span> <span class="ow">and</span> <span class="n">roadway_changes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;roadway_log_file&#39; and &#39;roadway_changes&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roadway_shp_file</span> <span class="ow">and</span> <span class="n">roadway_changes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;roadway_shp_file&#39; and &#39;roadway_changes&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roadway_csv_file</span> <span class="ow">and</span> <span class="n">roadway_changes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;roadway_csv_file&#39; and &#39;roadway_changes&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roadway_log_file</span> <span class="ow">and</span> <span class="n">roadway_csv_file</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;roadway_log_file&#39; and &#39;roadway_csv_file&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roadway_shp_file</span> <span class="ow">and</span> <span class="n">roadway_csv_file</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;roadway_shp_file&#39; and &#39;roadway_csv_file&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roadway_log_file</span> <span class="ow">and</span> <span class="n">roadway_shp_file</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;roadway_log_file&#39; and &#39;roadway_shp_file&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roadway_log_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">project_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">roadway_log_file</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">project_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roadway_log_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Project Name - Using name of first log file in list&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">project_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roadway_log_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Project Name - Using name of log file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roadway_log_file</span><span class="p">:</span>
            <span class="n">roadway_changes</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">read_logfile</span><span class="p">(</span><span class="n">roadway_log_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">roadway_shp_file</span><span class="p">:</span>
            <span class="n">roadway_changes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">roadway_shp_file</span><span class="p">)</span>
            <span class="n">roadway_changes</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">roadway_changes</span><span class="p">[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">roadway_csv_file</span><span class="p">:</span>
            <span class="n">roadway_changes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">roadway_csv_file</span><span class="p">)</span>
            <span class="n">roadway_changes</span><span class="p">[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">roadway_changes</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No roadway changes given or processed.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">roadway_changes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>

        <span class="k">if</span> <span class="n">base_roadway_network</span> <span class="ow">and</span> <span class="n">base_roadway_dir</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Method takes only one of &#39;base_roadway_network&#39; and &#39;base_roadway_dir&#39; but both given&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_roadway_dir</span><span class="p">:</span>
            <span class="n">base_roadway_network</span> <span class="o">=</span> <span class="n">ModelRoadwayNetwork</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_roadway_dir</span><span class="p">,</span> <span class="s2">&quot;link.json&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_roadway_dir</span><span class="p">,</span> <span class="s2">&quot;node.geojson&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_roadway_dir</span><span class="p">,</span> <span class="s2">&quot;shape.geojson&quot;</span><span class="p">),</span>
                <span class="n">fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">recalculate_calculated_variables</span><span class="o">=</span><span class="n">recalculate_calculated_variables</span><span class="p">,</span>
                <span class="n">recalculate_distance</span><span class="o">=</span><span class="n">recalculate_distance</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">base_roadway_network</span><span class="o">.</span><span class="n">split_properties_by_time_period_and_category</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">base_roadway_network</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No base roadway network.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">base_roadway_network</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span>
            <span class="n">roadway_changes</span><span class="o">=</span><span class="n">roadway_changes</span><span class="p">,</span>
            <span class="n">transit_changes</span><span class="o">=</span><span class="n">transit_changes</span><span class="p">,</span>
            <span class="n">base_roadway_network</span><span class="o">=</span><span class="n">base_roadway_network</span><span class="p">,</span>
            <span class="n">base_transit_network</span><span class="o">=</span><span class="n">base_transit_network</span><span class="p">,</span>
            <span class="n">build_transit_network</span><span class="o">=</span><span class="n">build_transit_network</span><span class="p">,</span>
            <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">project</span></div>

<div class="viewcode-block" id="Project.read_logfile"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.read_logfile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_logfile</span><span class="p">(</span><span class="n">logfilename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a Cube log file and returns a dataframe of roadway_changes</span>

<span class="sd">        Args:</span>
<span class="sd">            logfilename (str or list[str]): File path to CUBE logfile or list of logfile paths.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A DataFrame reprsentation of the log file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">logfilename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">logfilename</span> <span class="o">=</span> <span class="p">[</span><span class="n">logfilename</span><span class="p">]</span>

        <span class="n">link_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">node_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">logfilename</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading logfile: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

                <span class="n">_node_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_content</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)]</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;node lines: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_node_lines</span><span class="p">))</span>
                <span class="n">_link_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_content</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)]</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;link lines: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_link_lines</span><span class="p">))</span>

                <span class="n">_nodecol</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION&quot;</span><span class="p">,</span> <span class="s2">&quot;GROUP&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_node_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node Cols: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_nodecol</span><span class="p">))</span>
                <span class="n">_linkcol</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION&quot;</span><span class="p">,</span> <span class="s2">&quot;GROUP&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_link_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Link Cols: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_linkcol</span><span class="p">))</span>

                <span class="n">_node_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_node_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span><span class="n">columns</span> <span class="o">=</span> <span class="n">_nodecol</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node DF: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_node_df</span><span class="p">))</span>
                <span class="n">_link_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_link_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span><span class="n">columns</span> <span class="o">=</span> <span class="n">_linkcol</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Link DF: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_link_df</span><span class="p">))</span>

                <span class="n">node_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">node_df</span><span class="p">,</span><span class="n">_node_df</span><span class="p">])</span>
                <span class="n">link_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">link_df</span><span class="p">,</span><span class="n">_link_df</span><span class="p">])</span>

        <span class="n">log_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">link_df</span><span class="p">,</span> <span class="n">node_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># CUBE logfile headers for string fields: NAME[111] instead of NAME, need to shorten that</span>
        <span class="n">log_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">log_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Processed </span><span class="si">{}</span><span class="s2"> Node lines and </span><span class="si">{}</span><span class="s2"> Link lines&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">node_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">link_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">log_df</span></div>

<div class="viewcode-block" id="Project.determine_roadway_network_changes_compatability"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.determine_roadway_network_changes_compatability">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">determine_roadway_network_changes_compatability</span><span class="p">(</span>
        <span class="n">base_roadway_network</span><span class="p">:</span> <span class="n">ModelRoadwayNetwork</span><span class="p">,</span>
        <span class="n">roadway_changes</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Parameters</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks to see that any links or nodes that change exist in base roadway network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Evaluating compatibility between roadway network changes and base network. Not evaluating deletions.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># CUBE log file saves all variable names in upper cases, need to convert them to be same as network</span>
        <span class="n">log_to_net_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">log_to_net_crosswalk</span><span class="p">)</span>
        <span class="n">log_to_net_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">log_to_net_df</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">],</span> <span class="n">log_to_net_df</span><span class="p">[</span><span class="s2">&quot;net&quot;</span><span class="p">]))</span>

        <span class="n">dbf_to_net_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">net_to_dbf_crosswalk</span><span class="p">)</span>
        <span class="n">dbf_to_net_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dbf_to_net_df</span><span class="p">[</span><span class="s2">&quot;dbf&quot;</span><span class="p">],</span> <span class="n">dbf_to_net_df</span><span class="p">[</span><span class="s2">&quot;net&quot;</span><span class="p">]))</span>

        <span class="n">roadway_changes</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">log_to_net_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">roadway_changes</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dbf_to_net_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># for links &quot;L&quot;  that change &quot;C&quot;,</span>
        <span class="c1"># find locations where there isn&#39;t a base roadway link</span>

        <span class="n">link_changes_df</span> <span class="o">=</span> <span class="n">roadway_changes</span><span class="p">[</span>
            <span class="p">(</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">OBJECT</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">OPERATION</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">link_merge_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">link_changes_df</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
            <span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;model_link_id&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">missing_links</span> <span class="o">=</span> <span class="n">link_merge_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_merge_df</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">missing_links</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Network missing the following AB links:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing_links</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># for links &quot;N&quot;  that change &quot;C&quot;,</span>
        <span class="c1"># find locations where there isn&#39;t a base roadway node</span>

        <span class="n">node_changes_df</span> <span class="o">=</span> <span class="n">roadway_changes</span><span class="p">[</span>
            <span class="p">(</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">OBJECT</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">OPERATION</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">node_merge_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">node_changes_df</span><span class="p">[[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">]],</span>
            <span class="n">base_roadway_network</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">missing_nodes</span> <span class="o">=</span> <span class="n">node_merge_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">node_merge_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">missing_nodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Network missing the following nodes:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing_nodes</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.evaluate_changes"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.evaluate_changes">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines which changes should be evaluated, initiates</span>
<span class="sd">        self.card_data to be an aggregation of transit and highway changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">highway_change_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">transit_change_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evaluating project changes.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">highway_change_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_highway_changes</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transit_changes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_transit_network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_transit_network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">transit_change_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_transit_changes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">card_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
            <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="n">transit_change_list</span> <span class="o">+</span> <span class="n">highway_change_list</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Project.add_transit_changes"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.add_transit_changes">[docs]</a>    <span class="k">def</span> <span class="nf">add_transit_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates changes between base and build transit objects and</span>
<span class="sd">        adds entries into the self.card_data dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">transit_change_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_transit_network</span><span class="o">.</span><span class="n">evaluate_differences</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_transit_network</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">transit_change_list</span></div>

<div class="viewcode-block" id="Project.add_highway_changes"><a class="viewcode-back" href="../../_generated/lasso.Project.html#lasso.Project.add_highway_changes">[docs]</a>    <span class="k">def</span> <span class="nf">add_highway_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit_variables_to_existing_network</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates changes from the log file based on the base highway object and</span>
<span class="sd">        adds entries into the self.card_data dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            limit_variables_to_existing_network (bool): True if no ad-hoc variables.  Default to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">string_col</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="c1">## if worth it, could also add some functionality  to network wrangler itself.</span>
        <span class="n">node_changes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">OBJECT</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">link_changes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roadway_changes</span><span class="o">.</span><span class="n">OBJECT</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_final_op</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">OPERATION_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;A&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">OPERATION_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="s2">&quot;N&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;D&quot;</span>
            <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">OPERATION_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;D&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">OPERATION_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="s2">&quot;C&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;A&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;A&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">OPERATION_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="s2">&quot;A&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;C&quot;</span>

        <span class="k">def</span> <span class="nf">_process_deletions</span><span class="p">(</span><span class="n">link_changes_df</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing link deletions&quot;</span><span class="p">)</span>

            <span class="n">cube_delete_df</span> <span class="o">=</span> <span class="n">link_changes_df</span><span class="p">[</span><span class="n">link_changes_df</span><span class="o">.</span><span class="n">OPERATION_final</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube_delete_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">links_to_delete</span> <span class="o">=</span> <span class="n">cube_delete_df</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">delete_link_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;Roadway Deletion&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">:</span> <span class="n">links_to_delete</span><span class="p">},</span>
                <span class="p">}</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Links Deleted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links_to_delete</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delete_link_dict</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No link deletions processed&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">delete_link_dict</span>

        <span class="k">def</span> <span class="nf">_process_link_additions</span><span class="p">(</span>
            <span class="n">link_changes_df</span><span class="p">,</span> <span class="n">limit_variables_to_existing_network</span>
        <span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing link additions&quot;</span><span class="p">)</span>
            <span class="n">cube_add_df</span> <span class="o">=</span> <span class="n">link_changes_df</span><span class="p">[</span><span class="n">link_changes_df</span><span class="o">.</span><span class="n">OPERATION_final</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cube_add_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No link additions processed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">limit_variables_to_existing_network</span><span class="p">:</span>
                <span class="n">add_col</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cube_add_df</span><span class="o">.</span><span class="n">columns</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_col</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cube_add_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_final&quot;</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="c1"># can leave out &quot;OPERATION_final&quot; from writing out, is there a reason to write it out?</span>

            <span class="n">add_link_properties</span> <span class="o">=</span> <span class="n">cube_add_df</span><span class="p">[</span><span class="n">add_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>

            <span class="c1"># WranglerLogger.debug(&quot;Add Link Properties: {}&quot;.format(add_link_properties))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Links Added&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">add_link_properties</span><span class="p">)))</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;Add New Roadway&quot;</span><span class="p">,</span> <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="n">add_link_properties</span><span class="p">}</span>

        <span class="k">def</span> <span class="nf">_process_node_additions</span><span class="p">(</span><span class="n">node_add_df</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing node additions&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">node_add_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No node additions processed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">add_nodes_dict_list</span> <span class="o">=</span> <span class="n">node_add_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;OPERATION_final&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span>
                <span class="s2">&quot;records&quot;</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Nodes Added&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">add_nodes_dict_list</span><span class="p">)))</span>

            <span class="k">return</span> <span class="n">add_nodes_dict_list</span>

        <span class="k">def</span> <span class="nf">_process_single_link_change</span><span class="p">(</span><span class="n">change_row</span><span class="p">,</span> <span class="n">changeable_col</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1">#  1. Find associated base year network values</span>
            <span class="n">base_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">change_row</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">change_row</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">base_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No match found in network for AB combination: (</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">). Incompatible base network.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">change_row</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">change_row</span><span class="o">.</span><span class="n">B</span>
                <span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">base_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Found more than one match in base network for AB combination: (</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">). Selecting first one to operate on but AB should be unique to network.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">B</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">base_row</span> <span class="o">=</span> <span class="n">base_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># WranglerLogger.debug(&quot;Properties with changes: {}&quot;.format(changeable_col))</span>

            <span class="c1"># 2. find columns that changed (enough)</span>
            <span class="n">changed_col</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">changeable_col</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Assessing Column: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="c1"># if it is the same as before, or a static value, don&#39;t process as a change</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">change_row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_row</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;roadway_class&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">change_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c1"># only look at distance if it has significantly changed</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;distance&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">abs</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">change_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">base_row</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
                            <span class="o">/</span> <span class="n">base_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">&gt;</span> <span class="mf">0.01</span>
                    <span class="p">):</span>
                        <span class="n">changed_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">changed_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Properties with changes that will be processed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">changed_col</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_col</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

            <span class="c1"># 3. Iterate through columns with changed values and structure the changes as expected in  project card</span>
            <span class="n">property_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">processed_properties</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changed_col</span><span class="p">:</span>
                <span class="c1"># WranglerLogger.debug(&quot;Processing Column: {}&quot;.format(c))</span>
                <span class="p">(</span>
                    <span class="n">p_base_name</span><span class="p">,</span>
                    <span class="n">p_time_period</span><span class="p">,</span>
                    <span class="n">p_category</span><span class="p">,</span>
                    <span class="n">managed_lane</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">column_name_to_parts</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                <span class="n">_d</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;existing&quot;</span><span class="p">:</span> <span class="n">base_row</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="n">change_row</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Project</span><span class="o">.</span><span class="n">CALCULATED_VALUES</span><span class="p">:</span>
                    <span class="n">_d</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="n">change_row</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="k">if</span> <span class="n">p_time_period</span><span class="p">:</span>
                    <span class="n">_d</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">time_period_to_time</span><span class="p">[</span><span class="n">p_time_period</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">p_category</span><span class="p">:</span>
                        <span class="n">_d</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_category</span>

                <span class="c1"># iterate through existing properties that have been changed and see if you should just add</span>
                <span class="k">if</span> <span class="n">p_base_name</span> <span class="ow">in</span> <span class="n">processed_properties</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">processed_p</span> <span class="ow">in</span> <span class="n">property_dict_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">processed_p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p_base_name</span><span class="p">:</span>
                            <span class="n">processed_p</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_d</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">p_time_period</span><span class="p">:</span>
                    <span class="n">property_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;property&quot;</span><span class="p">:</span> <span class="n">p_base_name</span><span class="p">,</span> <span class="s2">&quot;timeofday&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">_d</span><span class="p">]}</span>
                    <span class="n">processed_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_base_name</span><span class="p">)</span>
                    <span class="n">property_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">property_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_d</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="n">processed_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">])</span>
                    <span class="n">property_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">)</span>

            <span class="n">card_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">property_dict_list</span><span class="p">]),</span>
                    <span class="s2">&quot;model_link_id&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">base_row</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]),</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># WranglerLogger.debug(&#39;single change card_df:\n {}&#39;.format(card_df))</span>

            <span class="k">return</span> <span class="n">card_df</span>

        <span class="k">def</span> <span class="nf">_process_link_changes</span><span class="p">(</span><span class="n">link_changes_df</span><span class="p">,</span> <span class="n">changeable_col</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">cube_change_df</span> <span class="o">=</span> <span class="n">link_changes_df</span><span class="p">[</span><span class="n">link_changes_df</span><span class="o">.</span><span class="n">OPERATION_final</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cube_change_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No link changes processed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">change_link_dict_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="s2">&quot;model_link_id&quot;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cube_change_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">card_df</span> <span class="o">=</span> <span class="n">_process_single_link_change</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">changeable_col</span><span class="p">)</span>

                <span class="n">change_link_dict_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">change_link_dict_df</span><span class="p">,</span> <span class="n">card_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">change_link_dict_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No link changes processed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="c1"># WranglerLogger.debug(&#39;change_link_dict_df Unaggregated:\n {}&#39;.format(change_link_dict_df))</span>

            <span class="c1"># Have to change to string so that it is a hashable type for the aggregation</span>
            <span class="n">change_link_dict_df</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change_link_dict_df</span><span class="p">[</span>
                <span class="s2">&quot;properties&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="c1"># Group the changes that are the same</span>
            <span class="n">change_link_dict_df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">change_link_dict_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">)[[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="c1"># WranglerLogger.debug(&#39;change_link_dict_df Aggregated:\n {}&#39;.format(change_link_dict_df))</span>

            <span class="c1"># Reformat model link id to correct &quot;facility&quot; format</span>
            <span class="n">change_link_dict_df</span><span class="p">[</span><span class="s2">&quot;facility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change_link_dict_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">model_link_id</span><span class="p">}]},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># WranglerLogger.debug(&#39;change_link_dict_df 3: {}&#39;.format(change_link_dict_df))</span>
            <span class="n">change_link_dict_df</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change_link_dict_df</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">change_link_dict_df</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Roadway Property Change&quot;</span>

            <span class="n">change_link_dict_list</span> <span class="o">=</span> <span class="n">change_link_dict_df</span><span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;facility&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;record&quot;</span><span class="p">)</span>

            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Changes Processed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">change_link_dict_list</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">change_link_dict_list</span>

        <span class="k">def</span> <span class="nf">_consolidate_actions</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">key_list</span><span class="p">):</span>
            <span class="n">log_df</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># will be changed if to allow new variables being added/changed that are not in base network</span>
            <span class="n">changeable_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">log_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">changeable_col</span><span class="p">:</span>
                <span class="n">log_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="n">action_history_df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">log_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">key_list</span><span class="p">)[</span><span class="s2">&quot;OPERATION&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;OPERATION_history&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="n">log_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">log_df</span><span class="p">,</span> <span class="n">action_history_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">key_list</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">log_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">key_list</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">log_df</span><span class="p">[</span><span class="s2">&quot;OPERATION_final&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_final_op</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">log_df</span><span class="p">[</span><span class="n">changeable_col</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;OPERATION_final&quot;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">link_changes_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">link_changes_df</span> <span class="o">=</span> <span class="n">_consolidate_actions</span><span class="p">(</span>
                <span class="n">link_changes_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_changes_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">node_changes_df</span> <span class="o">=</span> <span class="n">_consolidate_actions</span><span class="p">(</span>
                <span class="n">node_changes_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># print error message for node change and node deletion</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">node_changes_df</span><span class="p">[</span><span class="n">node_changes_df</span><span class="o">.</span><span class="n">OPERATION_final</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">])])</span>
                <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;NODE changes and deletions are not allowed!&quot;</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">node_add_df</span> <span class="o">=</span> <span class="n">node_changes_df</span><span class="p">[</span><span class="n">node_changes_df</span><span class="o">.</span><span class="n">OPERATION_final</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_add_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># process deletions</span>
        <span class="n">delete_link_dict</span> <span class="o">=</span> <span class="n">_process_deletions</span><span class="p">(</span><span class="n">link_changes_df</span><span class="p">)</span>

        <span class="c1"># process additions</span>
        <span class="n">add_link_dict</span> <span class="o">=</span> <span class="n">_process_link_additions</span><span class="p">(</span>
            <span class="n">link_changes_df</span><span class="p">,</span> <span class="n">limit_variables_to_existing_network</span>
        <span class="p">)</span>
        <span class="n">add_link_dict</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_process_node_additions</span><span class="p">(</span><span class="n">node_add_df</span><span class="p">)</span>

        <span class="c1"># process changes</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing changes&quot;</span><span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">link_changes_df</span><span class="p">)</span>
        <span class="n">changeable_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">link_changes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">Project</span><span class="o">.</span><span class="n">STATIC_VALUES</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">cols_in_changes_not_in_net</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">link_changes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_roadway_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">cols_in_changes_not_in_net</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The following attributes are specified in the changes but do not exist in the base network: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cols_in_changes_not_in_net</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">change_link_dict_list</span> <span class="o">=</span> <span class="n">_process_link_changes</span><span class="p">(</span><span class="n">link_changes_df</span><span class="p">,</span> <span class="n">changeable_col</span><span class="p">)</span>

        <span class="c1"># combine together</span>

        <span class="n">highway_change_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">delete_link_dict</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">add_link_dict</span><span class="p">]</span> <span class="o">+</span> <span class="n">change_link_dict_list</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">highway_change_list</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019 Metropolitan Council

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>